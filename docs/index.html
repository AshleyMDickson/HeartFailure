<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ashley Dickson">
<meta name="dcterms.date" content="2027-05-09">

<title>Internal Validation &amp; Sample Size in Clinical Risk Prediction Models – Modelling Binary Outcomes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Modelling Binary Outcomes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Welcome</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a>
  <ul class="collapse">
  <li><a href="#finding-alpha" id="toc-finding-alpha" class="nav-link" data-scroll-target="#finding-alpha">Finding <span class="math inline">\(\alpha\)</span></a></li>
  </ul></li>
  <li><a href="#data-generating-process" id="toc-data-generating-process" class="nav-link" data-scroll-target="#data-generating-process">Data Generating Process</a></li>
  <li><a href="#validation-procedures" id="toc-validation-procedures" class="nav-link" data-scroll-target="#validation-procedures">Validation Procedures</a></li>
  <li><a href="#initial-sample-size-recommendation" id="toc-initial-sample-size-recommendation" class="nav-link" data-scroll-target="#initial-sample-size-recommendation">Initial Sample Size Recommendation</a></li>
  <li><a href="#a-single-simulation-run" id="toc-a-single-simulation-run" class="nav-link" data-scroll-target="#a-single-simulation-run">A Single Simulation Run</a></li>
  <li><a href="#scenario-grid" id="toc-scenario-grid" class="nav-link" data-scroll-target="#scenario-grid">Scenario Grid</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo">TODO</a></li>
  <li><a href="#plots" id="toc-plots" class="nav-link" data-scroll-target="#plots">Plots</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Internal Validation &amp; Sample Size in Clinical Risk Prediction Models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ashley Dickson </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 9, 2027</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this document, I consider the effect of internal validation requirements on sample size requirements. Recent papers by Riley et al.&nbsp;(YYYY) and Pavlou et al.&nbsp;(YYYY) have made recommendations on the sample size required to achieve a particular level of model performance, usually expressed in terms of the C-statistic and Calibration slope. Inputs to these calculations also depend on the marginal prevalence of the target outcome and the number of prediction parameters to be estimated. Supplying these inputs to Pavlou et al.’s <code>sampsizedev</code> package in R, for instance, will yield the recommended sample size, from which further model performance metrics are then derived.</p>
<p>However, the sample size recommendations in the literature so far relate to model development. Less attention has been paid to the sample size requirements given the need to internally validate models before they can be used in clinical practice.</p>
<p>While external validation is the gold standard, and should be completed prior to deployment into clinical care, it is often not possible or practical for well-established reasons (citation needed). Further, internal validation is needed in model specification and variable selection. The simplest case - sample splitting - illustrates the need for the present study. If we have recruited exactly the right number of patients per the recommendation, then in sample-splitting we will invariably have too few patients for model development and training. The hold-out patients needed to validate will be deleterious on the possible model performance that can be achieved.</p>
<p>The solution in the simple case of sample splitting is easy: we simply choose our split ratio (say 70/30) and uplift the recommendation accordingly (i.e.&nbsp;multiply by 1.43, or recruit 43% more patients.) But in other methods of internal validation, the problem is not so simple. In these more interesting cases, we do not know (a) what effect, if any, imposing internal validation requirements on the recommended sample size will have, and (b) where there is an effect, what its size would be. We might hypothesise that k-fold cross validation may have a similar effect to sample splitting, because each trained model is on too small a sample - and no amount of repetition will help. But in bootstrap resampling, all the data are used in both development and testing, so there may be no effect at all.</p>
<p>Here I run some simulations to try to answer the question of whether internal validation has a deleterious effect on model performance at the recommended sample size, and if so, by how much the sample size needs to be uplifted to account for it. I keep this first run simple and use standard (non-shrunk) logit models, keeping the number of predictor parameters fixed at 10, and vary the prevalence and hence events per predictor parameter (EPP).</p>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<p>We begin by setting up some essential maths and importing the relevant libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(samplesizedev)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rms)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel setup</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>n_workers <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>L, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>L)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> n_workers)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">RNGkind</span>(<span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">log</span>(p<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> p))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>expit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The expit function is the inverse of the logit function, representing the core logistic model which we use:</p>
<p><span class="math display">\[
P(Y = 1 \mid X) = \frac{1}{1 + e^{-(\alpha + \beta X)}}
\]</span></p>
<p>We need a method of creating different data-generating processes (DGPs) for varying prevalence values but with constant beta-coefficients. Let’s start with an example and generate some simulation data with a target prevalence of 1.5%. To achieve this, we need <span class="math inline">\(Pr(Y=1) = 0.015\)</span>.</p>
<p>This is the marginal probability rather than the conditional on <span class="math inline">\(X\)</span>. Another way to express this is that the expectation of the dependent variable, <span class="math inline">\(Y\)</span>, should be 0.15:<span class="math inline">\(\mathbb{E}[Y] = 0.015\)</span>.</p>
<p>We know that the dependent variable Y takes on values from the conditional distribution:</p>
<p><span class="math display">\[
Y|X \sim Bernoulli (p),
\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the conditional probability of success, <span class="math inline">\(p_i=Pr(Y=1 | X_i)\)</span>. From the definition of the logit transformation (and dropping subscript),</p>
<p><span class="math display">\[
log(\frac{p}{1-p}) = \alpha + \beta X = \eta
\]</span></p>
<p>we find p as the inverse-logit of the linear predictors</p>
<p><span class="math display">\[
p = logit^{-1} (\eta) = \frac{1}{1+e^{-(\eta)}},
\]</span></p>
<p>which we know is equal to the conditional expectation <span class="math inline">\(\mathbb{E}[Y|X]\)</span>. Since <span class="math inline">\(Pr(Y=1)=\mathbb{E}[Y]\)</span>, which in turn are equal to the expectation of the conditional probability of success, <span class="math inline">\(\mathbb{E} [Pr(Y=1 | X)]\)</span>, we can substitute the logit model to find:</p>
<p><span class="math display">\[
\mathbb{E} [ \frac{1}{1+e^{(-\eta)}} ] = 0.015,
\]</span></p>
<p>where <span class="math inline">\(\beta\)</span> is a vector of coefficients and <span class="math inline">\(X\)</span> is a vector of predictor values.</p>
<p>Once we have chosen our values for <span class="math inline">\(\beta\)</span>, we need to solve for <span class="math inline">\(\alpha\)</span> to find the value which guarantees the required level of prevalence.</p>
<section id="finding-alpha" class="level3">
<h3 class="anchored" data-anchor-id="finding-alpha">Finding <span class="math inline">\(\alpha\)</span></h3>
<p>In a sample setting, we do not have an analytic distribution over which to take an expectation, so instead we can take a simple average, as</p>
<p><span class="math display">\[
\frac{1}{n} \sum_{i=1}^{n} (\frac{1}{1+e^{(-\eta)}}) = 0.015.
\]</span></p>
<p>For the sake of simplicity we choose 10 continuous predictors drawn from the standard normal distribution, <span class="math inline">\(X_j \sim \mathcal{N} (0, 1)\)</span>. We shall come to sample size calculations shortly, but for now let’s suppose we have 3,000 records.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>prev <span class="ot">=</span> <span class="fl">0.015</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we generate the predictors and choose the beta coefficients including some zeroes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">rnorm</span>(n))        <span class="co">#n*10 matrix</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"x"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.1</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now solve; technically, we’re solving the following for <span class="math inline">\(\alpha\)</span>:</p>
<p><span class="math display">\[
\frac{1}{n} \sum_{i=1}^{n} (\frac{1}{1 + e^{\alpha + \beta X}}) - 0.015 = 0
\]</span></p>
<p>In R, we can use the <code>uniroot</code> function to solve this and and we wrap it into a function for use later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>find_alpha <span class="ot">&lt;-</span> <span class="cf">function</span>(a) <span class="fu">mean</span>(<span class="fu">expit</span>(a <span class="sc">+</span> <span class="fu">as.vector</span>(X <span class="sc">%*%</span> beta))) <span class="sc">-</span> prev</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(find_alpha, <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">10</span>))<span class="sc">$</span>root</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -5.991107</code></pre>
</div>
</div>
<p>With <span class="math inline">\(\alpha \approx -5.8\)</span> in hand, we can now generate probabilities and outcomes, checking that the prevalence is approximately as expected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">&lt;-</span> <span class="fu">expit</span>(alpha <span class="sc">+</span> <span class="fu">as.vector</span>(X <span class="sc">%*%</span> beta))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pi)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(y)<span class="sc">/</span><span class="fu">length</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.017</code></pre>
</div>
</div>
</section>
</section>
<section id="data-generating-process" class="level2">
<h2 class="anchored" data-anchor-id="data-generating-process">Data Generating Process</h2>
<p>We’ll simulate binary outcomes under a simple logistic model with p = 10 standard normal predictors. Coefficients <span class="math inline">\(\beta\)</span> are drawn once per dataset from N(0,1). We choose the intercept so that the marginal prevalence equals a target prevalence using the method from above. This lets us vary <span class="math inline">\(\phi\)</span> (and thus EPP) directly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>simulate_logistic_data <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">p =</span> <span class="dv">10</span>, <span class="at">phi =</span> <span class="fl">0.20</span>) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p), n, p)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"x"</span>, <span class="fu">seq_len</span>(p))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p, <span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># standard normal coefficients</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  xb <span class="ot">&lt;-</span> X <span class="sc">%*%</span> beta</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">function</span>(b0) <span class="fu">mean</span>(<span class="fu">expit</span>(b0 <span class="sc">+</span> xb)) <span class="sc">-</span> phi</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  b0 <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(f, <span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">12</span>))<span class="sc">$</span>root</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> b0 <span class="sc">+</span> xb</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  p_true <span class="ot">&lt;-</span> <span class="fu">expit</span>(eta)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_true)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">df  =</span> <span class="fu">cbind</span>(<span class="fu">as.data.frame</span>(X), <span class="at">y =</span> y),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> beta,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0   =</span> b0,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi  =</span> phi</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This DGP is capable of generating a dataset for model development and testing of any sample size with a fixed number of Predictor Parameters and a variable prevalence, <span class="math inline">\(\phi\)</span>. Next we’ll need some supporting functions that we can use to easily fit the relevant logistic model to each sample and to generate predictions in new data (which will be needed for validation). I’ve also given a simple function to bring together a collection of performance metrics to be used across validation methods (and which can be updated in due course.) It take an outcome <span class="math inline">\(y\)</span>, a predicted probability, and a vector of linear predictors as inputs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(df, formula) <span class="fu">glm</span>(formula, <span class="at">data =</span> df, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>predict_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, newdata) <span class="fu">predict</span>(mod, newdata, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perf. metrics</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>calc_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(y, p, <span class="at">lp =</span> <span class="fu">qlogis</span>(<span class="fu">pmin</span>(<span class="fu">pmax</span>(p, <span class="fl">1e-6</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-6</span>))) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUC      =</span> <span class="fu">as.numeric</span>(pROC<span class="sc">::</span><span class="fu">roc</span>(y, p, <span class="at">quiet =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>auc),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">CalSlope =</span> <span class="fu">coef</span>(<span class="fu">glm</span>(y <span class="sc">~</span> lp, <span class="at">family =</span> <span class="fu">binomial</span>()))[<span class="dv">2</span>],</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier    =</span> <span class="fu">mean</span>((p <span class="sc">-</span> y)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAPE     =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(p <span class="sc">-</span> y))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="validation-procedures" class="level2">
<h2 class="anchored" data-anchor-id="validation-procedures">Validation Procedures</h2>
<p>To understand the optimism of a given model, we first need to understand its apparent performance, which is unadjusted and assesses predictive performance in the training data. To assess this, we need to supply a function with the original (training) dataset and the model formula used in estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>apparent_perf <span class="ot">&lt;-</span> <span class="cf">function</span>(df, formula) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">fit_logistic</span>(df, formula)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  p   <span class="ot">&lt;-</span> <span class="fu">predict_prob</span>(mod, df)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  lp  <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">metrics =</span> <span class="fu">calc_metrics</span>(df<span class="sc">$</span>y, p, lp), <span class="at">model =</span> mod)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having calculated apparent performance, we can then go on the calulate k-fold Cross Validation performance in which we take <span class="math inline">\(k\)</span> resamples, train on <span class="math inline">\(k-1\)</span> of them and test on the remaining resample, and do this k times (once for each resample).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>kfold_cv_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(df, formula, <span class="at">K =</span> <span class="dv">10</span>) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  folds <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">vfold_cv</span>(df, <span class="at">v =</span> K, <span class="at">strata =</span> <span class="st">"y"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  mets <span class="ot">&lt;-</span> <span class="fu">lapply</span>(folds<span class="sc">$</span>splits, <span class="cf">function</span>(sp) {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    train <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">analysis</span>(sp)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    test  <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">assessment</span>(sp)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    mod   <span class="ot">&lt;-</span> <span class="fu">fit_logistic</span>(train, formula)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    p     <span class="ot">&lt;-</span> <span class="fu">predict_prob</span>(mod, test)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    lp    <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> test, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calc_metrics</span>(test<span class="sc">$</span>y, p, lp)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, mets) <span class="sc">/</span> <span class="fu">length</span>(mets)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(out)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here I have used a simple mean of the performance metric across the folds. This is not optimal and in the next version will include pooled predictions in Cross Validation if it is deemed a productive line of enquiry.</p>
<p>Next I set up the function to run the Bootstrap validation, which resamples the data with replacement 200 times (by convention), fits the model on the resample and generates in-bag and out-of-bag predictions to calculate the optimism (as mean(in - out) and corrects it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>bootstrap_optimism <span class="ot">&lt;-</span> <span class="cf">function</span>(df, formula, <span class="at">B =</span> <span class="dv">200</span>) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  app_full <span class="ot">&lt;-</span> <span class="fu">apparent_perf</span>(df, formula)<span class="sc">$</span>metrics</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  opt_mat <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    dfb <span class="ot">&lt;-</span> df[idx, ]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">fit_logistic</span>(dfb, formula)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in-bag</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    p_in  <span class="ot">&lt;-</span> <span class="fu">predict_prob</span>(mod, dfb)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    lp_in <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> dfb, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    m_in  <span class="ot">&lt;-</span> <span class="fu">calc_metrics</span>(dfb<span class="sc">$</span>y, p_in, lp_in)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># out-of-bag (original dev data)</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    p_out  <span class="ot">&lt;-</span> <span class="fu">predict_prob</span>(mod, df)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    lp_out <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> df, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    m_out  <span class="ot">&lt;-</span> <span class="fu">calc_metrics</span>(df<span class="sc">$</span>y, p_out, lp_out)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(m_in <span class="sc">-</span> m_out)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  optimism <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(opt_mat)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  corrected <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(app_full) <span class="sc">-</span> optimism</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(corrected) <span class="ot">&lt;-</span> <span class="fu">names</span>(app_full)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="fu">as.list</span>(corrected))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally in this section, I provide a simple method of external validation such that we can compare internally-validated performance with ‘true’, gold-standard external. I generate some new logistic data using the same Data Generating Process from the <code>simulate_logistic_data()</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>external_perf <span class="ot">&lt;-</span> <span class="cf">function</span>(fitted_model, p, phi, <span class="at">N_ext =</span> <span class="dv">200000</span>) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  sim_ext <span class="ot">&lt;-</span> <span class="fu">simulate_logistic_data</span>(N_ext, <span class="at">p =</span> p, <span class="at">phi =</span> phi)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  df_ext  <span class="ot">&lt;-</span> sim_ext<span class="sc">$</span>df</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  p_hat   <span class="ot">&lt;-</span> <span class="fu">predict_prob</span>(fitted_model, df_ext)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  lp_hat  <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">newdata =</span> df_ext, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calc_metrics</span>(df_ext<span class="sc">$</span>y, p_hat, lp_hat)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By drawing 200,000 samples as the external dataset we are able to approach the asymptotic domain and draw inferences accordingly when making the comparison with internally-validated model performance.</p>
</section>
<section id="initial-sample-size-recommendation" class="level2">
<h2 class="anchored" data-anchor-id="initial-sample-size-recommendation">Initial Sample Size Recommendation</h2>
<p>In the simulation scenarios below, I start with the recommended sample size from Pavlou et al.’s <code>samplesizedev</code> package. I assume that the target calibration slope is <span class="math inline">\(CS_{target} = 0.9\)</span> for simplicity; this can be varied in future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>pavlou_dev_n <span class="ot">&lt;-</span> <span class="cf">function</span>(p, phi, c_stat, <span class="at">target_slope =</span> <span class="fl">0.90</span>) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">&lt;-</span> <span class="fu">samplesizedev</span>(<span class="at">outcome =</span> <span class="st">"Binary"</span>, <span class="at">S =</span> target_slope, <span class="at">phi =</span> phi, <span class="at">c =</span> c_stat, <span class="at">p =</span> p)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">N_sim =</span> ss<span class="sc">$</span>sim, <span class="at">N_rvs =</span> ss<span class="sc">$</span>rvs)  <span class="co"># use N_sim for primary decisions</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this sample size, we can invoke Pavlou’s <code>expected_performance</code> method such that we can compare with the external performance results and then understand the damage, if any, to model performance estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pavlou_expected <span class="ot">&lt;-</span> <span class="cf">function</span>(n, p, phi, c_stat) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expected_performance</span>(<span class="at">outcome =</span> <span class="st">"Binary"</span>, <span class="at">n =</span> n, <span class="at">phi =</span> phi, <span class="at">c =</span> c_stat, <span class="at">p =</span> p)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll centre our scenarios around Pavlou’s N (targeting S=0.90, by default), then test a few multipliers below/above to see what internal validation needs to be trustworthy.</p>
</section>
<section id="a-single-simulation-run" class="level2">
<h2 class="anchored" data-anchor-id="a-single-simulation-run">A Single Simulation Run</h2>
<p>With this setup in hand, we can generate a single simulation run using the simulated data, validation methods, and performance metric calculations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>run_rep <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">p =</span> <span class="dv">10</span>, <span class="at">phi =</span> <span class="fl">0.20</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">B_boot =</span> <span class="dv">200</span>, <span class="at">K =</span> <span class="dv">10</span>, <span class="at">c_stat_anticipated =</span> <span class="fl">0.80</span>) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">simulate_logistic_data</span>(n, p, phi)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  df  <span class="ot">&lt;-</span> sim<span class="sc">$</span>df</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"y ~"</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(df)[<span class="fu">colnames</span>(df) <span class="sc">!=</span> <span class="st">"y"</span>], <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run validation methods</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  app  <span class="ot">&lt;-</span> <span class="fu">apparent_perf</span>(df, form)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  boot <span class="ot">&lt;-</span> <span class="fu">bootstrap_optimism</span>(df, form, <span class="at">B =</span> B_boot)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  cv   <span class="ot">&lt;-</span> <span class="fu">kfold_cv_mean</span>(df, form, <span class="at">K =</span> K)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  ext  <span class="ot">&lt;-</span> <span class="fu">external_perf</span>(app<span class="sc">$</span>model, p, phi)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract metrics</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  AUC_app    <span class="ot">&lt;-</span> app<span class="sc">$</span>metrics<span class="sc">$</span>AUC</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  AUC_boot   <span class="ot">&lt;-</span> boot<span class="sc">$</span>AUC</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  AUC_cv     <span class="ot">&lt;-</span> cv<span class="sc">$</span>AUC</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  AUC_ext    <span class="ot">&lt;-</span> ext<span class="sc">$</span>AUC</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  Slope_app  <span class="ot">&lt;-</span> app<span class="sc">$</span>metrics<span class="sc">$</span>CalSlope</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  Slope_boot <span class="ot">&lt;-</span> boot<span class="sc">$</span>CalSlope</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  Slope_cv   <span class="ot">&lt;-</span> cv<span class="sc">$</span>CalSlope</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  Slope_ext  <span class="ot">&lt;-</span> ext<span class="sc">$</span>CalSlope</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  Brier_app  <span class="ot">&lt;-</span> app<span class="sc">$</span>metrics<span class="sc">$</span>Brier</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  Brier_boot <span class="ot">&lt;-</span> boot<span class="sc">$</span>Brier</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  Brier_cv   <span class="ot">&lt;-</span> cv<span class="sc">$</span>Brier</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  Brier_ext  <span class="ot">&lt;-</span> ext<span class="sc">$</span>Brier</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  MAPE_app   <span class="ot">&lt;-</span> app<span class="sc">$</span>metrics<span class="sc">$</span>MAPE</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  MAPE_boot  <span class="ot">&lt;-</span> boot<span class="sc">$</span>MAPE</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  MAPE_cv    <span class="ot">&lt;-</span> cv<span class="sc">$</span>MAPE</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  MAPE_ext   <span class="ot">&lt;-</span> ext<span class="sc">$</span>MAPE</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  pav_N      <span class="ot">&lt;-</span> <span class="fu">pavlou_dev_n</span>(p, phi, c_stat_anticipated, <span class="at">target_slope =</span> <span class="fl">0.90</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  exp_at_n   <span class="ot">&lt;-</span> <span class="fu">pavlou_expected</span>(n, p, phi, c_stat_anticipated)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine rows</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n, <span class="at">p =</span> p, <span class="at">phi =</span> phi, <span class="at">EPP =</span> n <span class="sc">*</span> phi <span class="sc">/</span> p,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUC_app =</span> AUC_app,     <span class="at">AUC_boot =</span> AUC_boot,     <span class="at">AUC_cv =</span> AUC_cv,     <span class="at">AUC_ext =</span> AUC_ext,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">Slope_app =</span> Slope_app, <span class="at">Slope_boot =</span> Slope_boot, <span class="at">Slope_cv =</span> Slope_cv, <span class="at">Slope_ext =</span> Slope_ext,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_app =</span> Brier_app, <span class="at">Brier_boot =</span> Brier_boot, <span class="at">Brier_cv =</span> Brier_cv, <span class="at">Brier_ext =</span> Brier_ext,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAPE_app  =</span> MAPE_app,  <span class="at">MAPE_boot  =</span> MAPE_boot,  <span class="at">MAPE_cv  =</span> MAPE_cv,  <span class="at">MAPE_ext  =</span> MAPE_ext,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">dAUC_app   =</span> AUC_app   <span class="sc">-</span> AUC_ext,</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">dAUC_boot  =</span> AUC_boot  <span class="sc">-</span> AUC_ext,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">dAUC_cv    =</span> AUC_cv    <span class="sc">-</span> AUC_ext,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">dSlope_app =</span> Slope_app <span class="sc">-</span> Slope_ext,</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">dSlope_boot=</span> Slope_boot<span class="sc">-</span> Slope_ext,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">dSlope_cv  =</span> Slope_cv  <span class="sc">-</span> Slope_ext,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">dBrier_app =</span> Brier_app <span class="sc">-</span> Brier_ext,</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">dBrier_boot=</span> Brier_boot<span class="sc">-</span> Brier_ext,</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">dBrier_cv  =</span> Brier_cv  <span class="sc">-</span> Brier_ext,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">dMAPE_app  =</span> MAPE_app  <span class="sc">-</span> MAPE_ext,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">dMAPE_boot =</span> MAPE_boot <span class="sc">-</span> MAPE_ext,</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">dMAPE_cv   =</span> MAPE_cv   <span class="sc">-</span> MAPE_ext,</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_Pavlou_sim =</span> pav_N<span class="sc">$</span>N_sim,</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">#N_Pavlou_RvS = pav_N$rvs, </span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">ExpSlope_at_n =</span> exp_at_n[<span class="st">"Mean_calibration_slope"</span>],</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">ExpMAPE_at_n  =</span> exp_at_n[<span class="st">"Mean_MAPE"</span>]</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each replication (i) computes internal validation performance, (ii) compares it to a large-sample external benchmark (bias), and (iii) records Pavlou’s recommended N and expected calibration/MAPE at the candidate n.</p>
</section>
<section id="scenario-grid" class="level2">
<h2 class="anchored" data-anchor-id="scenario-grid">Scenario Grid</h2>
<p>We now want to run the scenario over multipliers of the sample size and populate a grid with the prevalence values, recommended sample sizes, and sample sizes that are scaled up according to the multipliers. The resulting dataframe gives all combinations of these.</p>
<p>With the <code>simulation_grid</code> function I then run the above single simulation over the set of scenarios and collects all results into a single table. This is run 200 times by default, but this can be scaled up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>build_grid_from_pavlou <span class="ot">&lt;-</span> <span class="cf">function</span>(phi_vals, <span class="at">p =</span> <span class="dv">10</span>, <span class="at">c_stat =</span> <span class="fl">0.80</span>, <span class="at">target_slope =</span> <span class="fl">0.90</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">multipliers =</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">1.3</span>, <span class="fl">1.6</span>, <span class="fl">2.0</span>)) {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">lapply</span>(phi_vals, <span class="cf">function</span>(phi) {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    Ns <span class="ot">&lt;-</span> <span class="fu">pavlou_dev_n</span>(<span class="at">p =</span> p, <span class="at">phi =</span> phi, <span class="at">c_stat =</span> c_stat, <span class="at">target_slope =</span> target_slope)<span class="sc">$</span>N_sim</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">n =</span> <span class="fu">round</span>(Ns <span class="sc">*</span> multipliers), <span class="at">phi =</span> phi)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, rows)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># simulation over the grid</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>simulate_grid_parallel <span class="ot">&lt;-</span> <span class="cf">function</span>(grid, <span class="at">n_reps =</span> <span class="dv">200</span>, <span class="at">B_boot =</span> <span class="dv">200</span>, <span class="at">K =</span> <span class="dv">10</span>, </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">c_stat_anticipated =</span> <span class="fl">0.80</span>) {</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a task table: one row per (scenario, replication)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  task_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    rbind,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(grid)), <span class="cf">function</span>(g) {</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">n   =</span> grid<span class="sc">$</span>n[g],</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> grid<span class="sc">$</span>phi[g],</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">rep =</span> <span class="fu">seq_len</span>(n_reps)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run one replication per task in parallel</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  res_list <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(task_df)),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) {</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run_rep</span>(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> task_df<span class="sc">$</span>n[i],</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">p =</span> <span class="dv">10</span>,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> task_df<span class="sc">$</span>phi[i],</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">B_boot =</span> B_boot,</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> K,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">c_stat_anticipated =</span> c_stat_anticipated</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">future.seed =</span> <span class="cn">TRUE</span>  <span class="co"># reproducible across workers</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">rbindlist</span>(res_list)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each prevalence value, we get the <code>samplesizedev</code> recommendation and evaluate n at (0.7, 1.0, 1.3, 1.6) × N. This whether internal validation good enough at Pavlou’s N and if not, how much larger does n need to be.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>summarise_results <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, <span class="at">slope_tol =</span> <span class="fl">0.05</span>) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  summarize_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, metric) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"app"</span> <span class="ot">=</span> <span class="st">"Apparent"</span>, <span class="st">"boot"</span> <span class="ot">=</span> <span class="st">"Bootstrap"</span>, <span class="st">"cv"</span> <span class="ot">=</span> <span class="st">"kfoldMean"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">rbindlist</span>(<span class="fu">lapply</span>(<span class="fu">names</span>(methods), <span class="cf">function</span>(m) {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>      col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"d"</span>, metric, <span class="st">"_"</span>, m)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      dt[, .(<span class="at">bias =</span> <span class="fu">mean</span>(<span class="fu">get</span>(col_name)),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">sd   =</span> <span class="fu">sd</span>(<span class="fu">get</span>(col_name)),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">get</span>(col_name)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> methods[m]),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>         by <span class="ot">=</span> .(n, phi, EPP)]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    }))[, metric <span class="sc">:</span><span class="er">=</span> metric][]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  mets <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"AUC"</span>, <span class="st">"Slope"</span>, <span class="st">"Brier"</span>, <span class="st">"MAPE"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(<span class="fu">lapply</span>(mets, <span class="cf">function</span>(m) <span class="fu">summarize_metric</span>(dt, m)))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sufficiency here means is the median bias within tolerance?</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  suff <span class="ot">&lt;-</span> dt[, .(</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">med_Slope_boot =</span> <span class="fu">median</span>(Slope_boot, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">med_Slope_ext  =</span> <span class="fu">median</span>(Slope_ext,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">ok_calib       =</span> <span class="fu">abs</span>(<span class="fu">median</span>(dSlope_boot, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">&lt;=</span> slope_tol</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> .(n, phi, EPP)]</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">perf =</span> perf, <span class="at">sufficiency =</span> suff)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The sufficiency flag reports whether bootstrap-corrected internal validation is close enough to external (within a tolerance of 0.05 on slope). Now we build a grid of results drawing on Pavlou’s recommended sample sizes and the set of multipliers to ascertain sufficiency.</p>
<pre><code>set.seed(112358)

phi_vals &lt;- c(0.05, 0.10, 0.20, 0.40)
grid &lt;- build_grid_from_pavlou(phi_vals, p = 10, c_stat = 0.80, target_slope = 0.90)

# Parallel run
sim_dt &lt;- simulate_grid_parallel(
  grid,
  n_reps = 30,
  B_boot = 100,
  K = 10,
  c_stat_anticipated = 0.80
)

sum_out &lt;- summarise_results(sim_dt, slope_tol = 0.05)
perf_summary &lt;- sum_out$perf
calib_ok     &lt;- sum_out$sufficiency</code></pre>
<p>Need to increase n_reps and B_boot values when running correctly.</p>
<pre><code># Which (phi, n) combos meet the calibration tolerance?
calib_ok %&gt;%
  arrange(phi, n) %&gt;%
  print(n = 50)
 
# Compare Pavlou's expected slope at n vs empirical bootstrap &amp; external
sim_dt %&gt;%
  select(n, phi, EPP, Slope_boot, Slope_ext, ExpSlope_at_n) %&gt;%
  group_by(n, phi, EPP) %&gt;%
  summarise(med_boot = median(Slope_boot),
            med_ext  = median(Slope_ext),
            exp_slope = first(ExpSlope_at_n),
            .groups = "drop") %&gt;%
  arrange(phi, n) %&gt;%
  print(n = 50)
 
# Bias summaries (AUC and slope) by method
perf_summary %&gt;%
  filter(metric %in% c("AUC", "Slope")) %&gt;%
  arrange(metric, phi, n, method) %&gt;%
  print(n = 80)</code></pre>
</section>
<section id="todo" class="level2">
<h2 class="anchored" data-anchor-id="todo">TODO</h2>
<p>Plot (i) heatmaps of sufficiency over {prevalence × multiplier}, and (ii) bias vs.&nbsp;EPP line charts by method.</p>
<p>Notes</p>
<p>Core question: At Pavlou’s recommended N (for target S=0.90), are internal validation estimates (especially bootstrap) sufficiently close to external?</p>
<p>If not, how much larger N is needed? The multipliers point toward answer.</p>
<p>Prevalence makes a difference by fixing p = 10 and varying ##, you naturally vary EPP, which is often considered in the literature.</p>
<p>Here I’ve used mean-of-folds in CV; a development will involve pooled-predictions as a robustness check.</p>
</section>
<section id="plots" class="level2">
<h2 class="anchored" data-anchor-id="plots">Plots</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>